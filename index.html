<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>11D1 - H·ªá Th·ªëng Xem ƒêi·ªÉm Pro</title>
    <link rel="icon" href="11d1.png" type="image/png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00f2ea;
            --primary-glow: rgba(0, 242, 234, 0.5);
            --secondary: #ff0055;
            --secondary-glow: rgba(255, 0, 85, 0.4);
            --accent: #7000ff;
            
            --bg-dark: #050511;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            --success: #00ff9d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Background --- */
        .bg-orb {
            position: fixed; border-radius: 50%; filter: blur(90px); z-index: -1; opacity: 0.4; animation: floatOrb 25s infinite alternate;
        }
        .orb-1 { top: -15%; left: -15%; width: 60vw; height: 60vw; background: var(--accent); }
        .orb-2 { bottom: -15%; right: -15%; width: 50vw; height: 50vw; background: var(--primary); animation-delay: -5s; }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* --- Layout --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-bottom: 120px; }

        /* --- HEADER & LOGO (UPGRADED) --- */
        header { text-align: center; margin-bottom: 50px; padding-top: 40px; position: relative; }
        
        .logo-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }

        /* Decoration Spinning Shape */
        .logo-decoration {
            position: absolute; top: 50%; left: 50%;
            width: 130%; height: 110%;
            transform: translate(-50%, -50%);
            z-index: -1;
            pointer-events: none;
        }
        .logo-shape {
            position: absolute; border-radius: 20px; border: 2px solid transparent;
        }
        .shape-1 {
            top: 0; left: 0; right: 0; bottom: 0;
            border-color: rgba(0, 242, 234, 0.1);
            animation: rotateShape 10s linear infinite;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
        }
        .shape-2 {
            top: 5px; left: 5px; right: 5px; bottom: 5px;
            border-color: rgba(255, 0, 85, 0.1);
            animation: rotateShape 15s linear infinite reverse;
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
        }

        .class-title {
            font-size: 6rem; /* Logo l·ªõn h∆°n */
            line-height: 1;
            font-weight: 900;
            letter-spacing: -3px;
            background: linear-gradient(135deg, #ffffff 0%, var(--primary) 60%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            /* T·∫°o ƒë·ªô n·ªïi 3D b·∫±ng shadow */
            filter: drop-shadow(0 0 20px rgba(0, 242, 234, 0.4));
            position: relative;
            z-index: 2;
        }

        /* Hi·ªáu ·ª©ng Shine ch·∫°y qua ch·ªØ */
        .class-title::after {
            content: ''; position: absolute; top: 0; left: -100%;
            width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg);
            animation: textShine 6s infinite;
            -webkit-background-clip: text; 
            pointer-events: none;
        }

        .sub-title {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-top: 10px;
            font-weight: 500;
            letter-spacing: 6px; /* Ch·ªØ c√°ch ƒë·ªÅu */
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            position: relative; z-index: 2;
        }

        /* --- Controls --- */
        .controls-wrapper { display: flex; flex-direction: column; gap: 20px; margin-bottom: 50px; align-items: center; }
        .search-box { position: relative; width: 100%; max-width: 500px; }
        .search-box input {
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
            padding: 16px 50px 16px 20px; border-radius: 50px; color: white; font-size: 1rem;
            font-family: inherit; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .search-box input:focus { border-color: var(--primary); box-shadow: 0 0 25px rgba(0, 242, 234, 0.15); background: rgba(0,0,0,0.6); }
        
        .term-switcher {
            display: flex; justify-content: center; gap: 5px; background: rgba(0,0,0,0.3);
            padding: 6px; border-radius: 50px; border: 1px solid var(--glass-border); backdrop-filter: blur(10px);
        }
        .term-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 10px 25px; border-radius: 40px; cursor: pointer;
            font-family: inherit; font-weight: 600; transition: all 0.3s ease;
        }
        .term-btn.active {
            background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary-glow); font-weight: 700;
        }

        /* --- Stats Cards (Polished) --- */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 60px; }
        .stat-card {
            background: linear-gradient(160deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--glass-border); padding: 25px; border-radius: 24px; position: relative; overflow: hidden;
            transition: 0.4s; backdrop-filter: blur(10px);
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        
        /* Gradient border effect */
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.5;
        }
        
        .stat-value { 
            font-size: 3.2rem; 
            font-weight: 700; 
            color: var(--text-main); 
            font-family: 'JetBrains Mono', monospace; /* Font s·ªë k·ªπ thu·∫≠t */
            letter-spacing: -1px;
            line-height: 1.1;
            background: linear-gradient(to bottom, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.5px; margin-top: 8px; font-weight: 600; }

        /* --- Loading Overlay --- */
        .pro-loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 17, 0.9); z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px);
        }
        .loader-ring {
            width: 60px; height: 60px; border: 3px solid transparent; border-top: 3px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; position: relative;
        }
        .loader-ring::before {
            content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
            border-radius: 50%; border: 3px solid transparent; border-bottom: 3px solid var(--secondary);
            animation: spin 2s linear infinite reverse;
        }
        .loader-text {
            margin-top: 20px; font-size: 0.9rem; color: var(--primary); letter-spacing: 3px;
            text-transform: uppercase; font-weight: 700; animation: blink 1.5s infinite;
        }

        /* --- Ranking Section --- */
        .section-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
        .section-title span { padding: 5px 15px; background: var(--secondary); border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
        .section-title span:hover { filter: brightness(1.2); }

        .ranking-container {
            background: rgba(20, 20, 35, 0.4); border-radius: 24px; padding: 5px;
            border: 1px solid var(--glass-border); margin-bottom: 60px; position: relative; min-height: 300px;
            backdrop-filter: blur(20px);
        }
        .ranking-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .ranking-table th { padding: 15px 20px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; font-weight: 600; }
        .ranking-table td {
            background: rgba(255, 255, 255, 0.02); padding: 15px 20px;
            border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border);
            transition: 0.2s;
        }
        .ranking-table tr:hover td { background: rgba(255, 255, 255, 0.06); transform: scale(1.005); }
        .ranking-table td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; text-align: center; border-left: 1px solid var(--glass-border); }
        .ranking-table td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; font-weight: 800; border-right: 1px solid var(--glass-border); }

        .rank-badge {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            border-radius: 10px; font-weight: 800; font-style: italic; font-family: 'Outfit';
        }
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #fff; box-shadow: 0 0 15px rgba(255,215,0,0.3); }
        .rank-2 { background: linear-gradient(135deg, #e0e0e0, #ffffff); color: #333; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a05a2c); color: #fff; }
        .rank-other { background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--glass-border); }

        /* --- Grid --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; }
        .student-card {
            background: rgba(255, 255, 255, 0.02); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 20px 10px; text-align: center; cursor: pointer;
            transition: 0.3s; position: relative;
        }
        .student-card:hover { transform: translateY(-10px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(0,242,234,0.1); }
        .avatar {
            width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 15px;
            background: linear-gradient(135deg, #333, #111); display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: 700; border: 2px solid var(--glass-border); overflow: hidden;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .st-name { font-size: 0.9rem; font-weight: 500; color: #fff; line-height: 1.3; }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.4s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-box {
            background: #0f1016; width: 92%; max-width: 900px; height: 90vh;
            border-radius: 24px; border: 1px solid var(--glass-border);
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.9); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-header {
            padding: 20px 30px; border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02);
        }
        .modal-title { font-weight: 700; color: var(--primary); font-size: 1.2rem; }
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; position: relative; background: #000; }
        .close-btn {
            background: rgba(255,255,255,0.1); border: none; color: #fff; width: 36px; height: 36px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .close-btn:hover { background: var(--secondary); transform: rotate(90deg); }
        
        /* List Items */
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px; margin-bottom: 12px; background: rgba(255,255,255,0.03);
            border-radius: 16px; border-left: 4px solid transparent; transition: 0.2s;
        }
        .list-item:hover { background: rgba(255,255,255,0.06); border-left-color: var(--primary); }
        .tag {
            background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 12px;
            font-size: 0.9rem; border: 1px solid var(--glass-border); margin-right: 5px; margin-bottom: 5px; display: inline-block;
        }

        /* --- Iframe --- */
        iframe { width: 100%; height: 100%; border: none; }
        .dark-mode-iframe { filter: invert(0.92) hue-rotate(180deg) contrast(0.9); }

        /* --- Animations --- */
        @keyframes floatOrb { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, 50px); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes rotateShape { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes textShine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

        @media (max-width: 768px) {
            .class-title { font-size: 4rem; letter-spacing: -1px; } 
            .sub-title { letter-spacing: 3px; font-size: 0.9rem; }
            .logo-decoration { width: 110%; height: 110%; }
            .modal-box { width: 100%; height: 100%; border-radius: 0; }
            .ranking-table th:nth-child(2), .ranking-table td:nth-child(2) { width: 50%; }
            .stat-value { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="container">
        <!-- HEADER & LOGO -->
        <header>
            <div class="logo-wrapper">
                <!-- Decoration shapes behind the logo -->
                <div class="logo-decoration">
                    <div class="logo-shape shape-1"></div>
                    <div class="logo-shape shape-2"></div>
                </div>
                <div class="class-title">11D1</div>
            </div>
            <div class="sub-title">NƒÉm H·ªçc 2025 - 2026</div>
        </header>

        <div class="controls-wrapper">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm h·ªçc sinh..." onkeyup="filterStudents()">
                <span style="position:absolute; right:20px; top:50%; transform:translateY(-50%); color:var(--text-muted)">üîç</span>
            </div>
            <div class="term-switcher">
                <button class="term-btn active" onclick="switchTerm(1)">H·ªçc K·ª≥ 1</button>
                <button class="term-btn" onclick="switchTerm(2)">H·ªçc K·ª≥ 2</button>
                <button class="term-btn" onclick="switchTerm(0)">C·∫£ NƒÉm</button>
            </div>
        </div>

        <!-- STATS SECTION (Refined Visuals) -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="totalStudents">0</div>
                <div class="stat-label">H·ªçc Sinh C√≥ ƒêi·ªÉm</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgClassScore">--</div>
                <div class="stat-label">ƒêi·ªÉm TB C·∫£ L·ªõp</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="topStudentName" style="font-size: 1.8rem; line-height: 1.5;">...</div>
                <div class="stat-label">Top 1 L·ªõp</div>
            </div>
        </div>

        <section id="ranking">
            <div class="section-title">
                B·∫£ng X·∫øp H·∫°ng 
                <span onclick="openModal('modalSubject')">Top 1 M√¥n</span>
                <span onclick="openModal('modalClassification')" style="background: var(--primary); color:black;">X·∫øp Lo·∫°i</span>
            </div>

            <div class="ranking-container">
                <div id="rankingLoading" class="pro-loader">
                    <div class="loader-ring"></div>
                    <div class="loader-text" id="loaderText">ƒêANG T·∫¢I...</div>
                </div>
                <table class="ranking-table" style="display:none;" id="rankingTable">
                    <thead>
                        <tr>
                            <th style="width: 10%">#</th>
                            <th style="width: 60%">H·ªç v√† T√™n</th>
                            <th style="width: 30%; text-align:right;">ƒêi·ªÉm TB</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody"></tbody>
                </table>
            </div>
        </section>

        <section id="grid">
            <div class="section-title">Danh S√°ch L·ªõp</div>
            <div class="grid" id="studentGrid"></div>
        </section>

        <footer style="text-align:center; margin-top:60px; color:var(--text-muted); font-size:0.8rem;">
            <p>Designed by Th·∫°ch M√¥ Ra (Rov) ¬© 2026</p>
        </footer>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalGrades">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title" id="gradeModalTitle">H·ªì S∆° H·ªçc Sinh</div>
                <button class="close-btn" onclick="closeModal('modalGrades')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="iframeLoader" class="pro-loader"><div class="loader-ring"></div></div>
                <iframe id="gradeIframe" class="dark-mode-iframe" style="opacity:0; transition: opacity 0.5s;"></iframe>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalSubject">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">Danh S√°ch Nh·∫•t M√¥n</div>
                <button class="close-btn" onclick="closeModal('modalSubject')">√ó</button>
            </div>
            <div class="modal-body" id="subjectList"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalClassification">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">Th·ªëng K√™ X·∫øp Lo·∫°i</div>
                <button class="close-btn" onclick="closeModal('modalClassification')">√ó</button>
            </div>
            <div class="modal-body" id="classList"></div>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH ===
        const BASE_API = "https://s19.vnedu.vn/v5/?call=app.mobile.hocsinh.getSLLView&app_truong_id=601067905&lop_hoc_id=5003407987&session_id=9d47affc-6f0b-4c86-902a-85f02cde0716&device_id=3f638bbb-df36-39bc-aa2f-76ebbfeb76e4&token=cb96a36858bb639cc34e5e8a0ef43a39&nam_hoc=2025";
        
        const students = [
            {name:"L·∫°i Qu·∫ø Anh",id:"5010453507"},{name:"L√Ω Ng·ªçc Lan Anh",id:"5010453527"},
            {name:"Nguy·ªÖn Th·ªã Ng·ªçc Anh",id:"5010453547"},{name:"Th·∫°ch Kim Anh",id:"5010453567"},
            {name:"Hu·ª≥nh Tuy·∫øt BƒÉng",id:"5010453587"},{name:"√îng Th·ªã Tuy·∫øt Chi",id:"5010453607"},
            {name:"L√™ Phong D√¢n",id:"5010453627"},{name:"Tr·∫ßn Th·ªã H·ªìng Di·ªáp",id:"5010453647"},
            {name:"L√¢m Tr∆∞·ªùng Duy",id:"5010453667"},{name:"Nguy·ªÖn L√¢m Nh·∫≠t Duy",id:"5010453687"},
            {name:"TƒÉng Ph∆∞·ªõc ƒê·∫°i",id:"5010453707"},{name:"Mai Lan Em",id:"5010453727"},
            {name:"Ph·∫°m T·∫•n ƒê·∫°t",id:"5010454367"},{name:"Hu·ª≥nh Ng·ªçc Giao",id:"5010453747"},
            {name:"L∆∞u Gia H√¢n",id:"5010453767"},{name:"Nguy·ªÖn Ng·ªçc Gia H√¢n",id:"5010453787"},
            {name:"Hu·ª≥nh VƒÉn H√≥a",id:"5010453807"},{name:"Du L√Ω Gia Khang",id:"5010454387"},
            {name:"L∆∞u V·ªπ Khang (Anh Hai)",id:"5010453827"},{name:"Nguy·ªÖn Thanh L√¢m",id:"5010453847"},
            {name:"Tr·∫ßn L√¢m",id:"5010453867"},{name:"Tri·ªáu Th·ªã Ng·ªçc Linh",id:"5010453887"},
            {name:"H·ª©a Kim L∆∞·ª£ng",id:"5010453907"},{name:"Qu√°ch Th·∫£o My",id:"5010453947"},
            {name:"L√¢m Kim Ng√¢n",id:"5010453967"},{name:"Tr·ªãnh Kh∆∞u M·ªπ Nghi",id:"5010453987"},
            {name:"Ong Th·ªã B·∫£o Ng·ªçc",id:"5010454007"},{name:"Phan Nguy·ªÖn Nh√£ Nguy√™n",id:"5010454027"},
            {name:"L√¢m ƒê·∫∑ng Ph∆∞·ª£ng Quy√™n",id:"5010454047"},{name:"Nguy·ªÖn Th·ªã Xu√¢n Qu·ª≥nh",id:"5010454067"},
            {name:"Th·∫°ch M√¥ Ra",id:"5010454087"},{name:"Hu·ª≥nh Ho√†ng T·∫•n",id:"5010454107"},
            {name:"Nguy·ªÖn T·∫•n Th·ªãnh",id:"5010454127"},{name:"Tr·∫ßn Th·ªã Anh Th∆∞",id:"5010454147"},
            {name:"L√¢m Ng·ªçc Ho√†i Th∆∞∆°ng",id:"5010454167"},{name:"Nguy·ªÖn Th·ªã Ng·ªçc Ti·∫øn",id:"5010454187"},
            {name:"Ch√¢u Th·ªã Th·ªßy Tr√∫c",id:"5010454207"},{name:"Tri·ªáu Thanh T√∫",id:"5010454227"},
            {name:"D∆∞∆°ng Th·ªã B√≠ch Tuy·ªÅn",id:"5010454247"},{name:"Tr·∫ßn VƒÉn T√Ω",id:"5010454267"},{name:"Hu·ª≥nh C√¥ng Vinh",id:"5010454347"},
            {name:"D∆∞∆°ng Th·ªã Ng·ªçc Vy",id:"5010454287"},{name:"Tr·ªãnh Th·ªã Kim Y·∫øn",id:"5010454327"}
        ];

        const MAIN_SUBJECTS = ["To√°n h·ªçc","V·∫≠t l√≠","Tin h·ªçc","Ng·ªØ vƒÉn","L·ªãch s·ª≠","ƒê·ªãa l√≠","Ngo·∫°i ng·ªØ","Gi√°o d·ª•c qu·ªëc ph√≤ng v√† an ninh","Gi√°o d·ª•c kinh t·∫ø v√† ph√°p lu·∫≠t"];
        
        let currentTerm = 1; 
        let studentsData = [];
        let avatarMap = {};
        let isFetching = false; 

        const fmt = (num) => parseFloat(num).toFixed(1);

        async function fetchStudentData(student) {
            try {
                const url = `${BASE_API}&hoc_ky_id=${currentTerm}&hoc_sinh_id=${student.id}`;
                const res = await fetch(url, { credentials: 'omit' });
                if (!res.ok) return { ...student, error: true };
                const text = await res.text();
                const doc = new DOMParser().parseFromString(text, 'text/html');
                const table = doc.querySelector('.table-point-content .table') || doc.querySelector('.table');
                if (!table) return { ...student, error: true };

                const rows = table.querySelectorAll('tbody tr');
                const headers = Array.from(table.querySelectorAll('thead th, thead td')).map(th => th.textContent.trim().toLowerCase());
                let tbmColIndex = headers.findIndex(h => h.includes('tb') || h.includes('trung b√¨nh'));
                if (tbmColIndex === -1) tbmColIndex = headers.length - 1;

                let totalScore = 0;
                let subjectCount = 0;
                let minScore = 10;
                let subjectScores = {};

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length <= tbmColIndex) return;
                    const subjName = cells[0].textContent.trim();
                    if (!subjName || subjName.includes('TB') || subjName.includes('Trung b√¨nh') || subjName.includes('T·ªïng')) return;

                    let cleanSubj = subjName;
                    if (subjName.includes('qu·ªëc ph√≤ng')) cleanSubj = "Gi√°o d·ª•c qu·ªëc ph√≤ng v√† an ninh";
                    if (subjName.includes('kinh t·∫ø')) cleanSubj = "Gi√°o d·ª•c kinh t·∫ø v√† ph√°p lu·∫≠t";

                    const valStr = cells[tbmColIndex]?.textContent.trim() || '';
                    const val = parseFloat(valStr.replace(/[^0-9.]/g, ''));

                    if (!isNaN(val) && val >= 0 && val <= 10) {
                        totalScore += val;
                        subjectCount++;
                        if (val < minScore) minScore = val;
                        if (MAIN_SUBJECTS.includes(cleanSubj)) subjectScores[cleanSubj] = val;
                    }
                });

                if (subjectCount === 0) return { ...student, error: true };

                return {
                    ...student,
                    avg: parseFloat((totalScore / subjectCount).toFixed(2)),
                    minScore: minScore,
                    subjectScores: subjectScores,
                    totalSubjectCount: subjectCount
                };

            } catch (err) {
                return { ...student, error: true };
            }
        }

        function switchTerm(term) {
            if (isFetching || currentTerm === term) return;
            currentTerm = term;
            document.querySelectorAll('.term-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText.toLowerCase().includes(term === 0 ? 'c·∫£ nƒÉm' : (term === 1 ? 'hk1' : 'hk2'))) {
                    btn.classList.add('active');
                }
            });
            document.getElementById('rankingLoading').style.display = 'flex';
            document.getElementById('rankingTable').style.display = 'none';
            document.getElementById('rankingBody').innerHTML = '';
            document.getElementById('loaderText').innerText = "ƒêANG C·∫¨P NH·∫¨T...";
            initApp();
        }

        async function initApp() {
            isFetching = true;
            if (Object.keys(avatarMap).length === 0) {
                try {
                    const avtRes = await fetch('avt.json');
                    if (avtRes.ok) avatarMap = await avtRes.json();
                } catch (e) { }
            }
            renderGrid();
            const promises = students.map(s => fetchStudentData(s));
            const results = await Promise.all(promises);
            studentsData = results.filter(r => !r.error);
            updateStats();
            renderRanking();
            document.getElementById('rankingLoading').style.display = 'none';
            document.getElementById('rankingTable').style.display = 'table';
            isFetching = false;
        }

        function renderGrid() {
            const grid = document.getElementById('studentGrid');
            grid.innerHTML = '';
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = students.filter(s => s.name.toLowerCase().includes(query));
            if(!isFetching) document.getElementById('totalStudents').textContent = studentsData.length;

            const frag = document.createDocumentFragment();
            filtered.forEach((s, index) => {
                const card = document.createElement('div');
                card.className = 'student-card';
                const avatarUrl = avatarMap[s.name];
                card.innerHTML = `
                    <div class="avatar">${avatarUrl ? `<img src="${avatarUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover">` : s.name.charAt(0)}</div>
                    <div class="st-name">${s.name}</div>
                `;
                card.onclick = () => openGradeModal(s.name, `${BASE_API}&hoc_ky_id=${currentTerm}&hoc_sinh_id=${s.id}`);
                frag.appendChild(card);
            });
            grid.appendChild(frag);
        }
        function filterStudents() { renderGrid(); }

        function updateStats() {
            if (studentsData.length === 0) {
                document.getElementById('totalStudents').textContent = "0";
                document.getElementById('avgClassScore').textContent = "--";
                document.getElementById('topStudentName').textContent = "Ch∆∞a c√≥";
                return;
            }
            const totalAvg = studentsData.reduce((sum, s) => sum + s.avg, 0);
            const classAvg = totalAvg / studentsData.length;
            const top = studentsData.reduce((prev, current) => (prev.avg > current.avg) ? prev : current);

            document.getElementById('totalStudents').textContent = studentsData.length;
            document.getElementById('avgClassScore').textContent = fmt(classAvg);
            document.getElementById('topStudentName').textContent = top.name;
        }

        function renderRanking() {
            const sorted = [...studentsData].sort((a, b) => b.avg - a.avg);
            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = ''; 

            if (sorted.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:30px; color:var(--text-muted)">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm s·ªë cho k·ª≥ n√†y</td></tr>`;
                return;
            }

            sorted.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.style.animation = `fadeInUp 0.5s forwards ${i * 0.05}s`;
                tr.style.opacity = '0';
                
                let rankClass = 'rank-other';
                if (i === 0) rankClass = 'rank-1';
                else if (i === 1) rankClass = 'rank-2';
                else if (i === 2) rankClass = 'rank-3';

                tr.innerHTML = `
                    <td><span class="rank-badge ${rankClass}">${i + 1}</span></td>
                    <td>
                        <div style="font-weight:600; color:${i < 3 ? 'var(--primary)' : '#fff'}">${s.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted)">${s.totalSubjectCount} m√¥n</div>
                    </td>
                    <td style="text-align:right; font-family:'JetBrains Mono'; font-size:1.1rem; color:${s.avg >= 8 ? 'var(--success)' : 'var(--text-main)'}">${fmt(s.avg)}</td>
                `;
                tr.onclick = () => openGradeModal(s.name, `${BASE_API}&hoc_ky_id=${currentTerm}&hoc_sinh_id=${s.id}`);
                tbody.appendChild(tr);
            });
        }

        function renderTopSubjects() {
            const container = document.getElementById('subjectList');
            container.innerHTML = '';
            MAIN_SUBJECTS.forEach(subj => {
                let topStudent = null; let maxScore = -1;
                studentsData.forEach(s => {
                    if (s.subjectScores[subj] !== undefined && s.subjectScores[subj] > maxScore) {
                        maxScore = s.subjectScores[subj]; topStudent = s;
                    }
                });
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div><div style="font-weight:700; color:#fff;">${subj}</div></div>
                    <div style="text-align:right"><div style="color:var(--success); font-weight:700">${topStudent ? fmt(maxScore) : '-'}</div><div style="font-size:0.9rem; color:var(--text-muted)">${topStudent ? topStudent.name : '--'}</div></div>
                `;
                container.appendChild(item);
            });
        }

        function renderClassification() {
            const container = document.getElementById('classList');
            container.innerHTML = '';
            const categories = { 'Gi·ªèi': [], 'Kh√°': [], 'Trung B√¨nh': [], 'Y·∫øu': [] };
            studentsData.forEach(s => {
                const avg = s.avg; const min = s.minScore;
                if (avg >= 8.0 && min >= 6.5) categories['Gi·ªèi'].push(s.name);
                else if (avg >= 6.5 && min >= 5.0) categories['Kh√°'].push(s.name);
                else if (avg >= 5.0) categories['Trung B√¨nh'].push(s.name);
                else categories['Y·∫øu'].push(s.name);
            });
            Object.keys(categories).forEach(type => {
                const list = categories[type]; 
                const group = document.createElement('div'); 
                group.style.marginBottom = '20px';
                let color = '#fff'; 
                if(type === 'Gi·ªèi') color = 'var(--success)'; 
                if(type === 'Kh√°') color = 'var(--primary)';
                group.innerHTML = `<div style="font-weight:700; color:${color}; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">${type} (${list.length})</div><div style="display:flex; flex-wrap:wrap; gap:8px">${list.map(name => `<span class="tag">${name}</span>`).join('')}</div>`;
                container.appendChild(group);
            });
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
            if (modalId === 'modalSubject') renderTopSubjects();
            if (modalId === 'modalClassification') renderClassification();
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = '';
            if (modalId === 'modalGrades') {
                document.getElementById('gradeIframe').src = '';
                document.getElementById('gradeIframe').style.opacity = '0';
                document.getElementById('iframeLoader').style.display = 'flex';
            }
        }
        function openGradeModal(name, url) {
            document.getElementById('gradeModalTitle').textContent = `H·ªì S∆°: ${name}`;
            document.getElementById('iframeLoader').style.display = 'flex';
            document.getElementById('gradeIframe').style.opacity = '0';
            const iframe = document.getElementById('gradeIframe');
            openModal('modalGrades');
            setTimeout(() => { iframe.src = url; }, 100);
            iframe.onload = () => { iframe.style.opacity = '1'; document.getElementById('iframeLoader').style.display = 'none'; };
        }

        window.addEventListener('load', () => { initApp(); });
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => { if (e.target === overlay) closeModal(overlay.id); });
        });
    </script>
</body>
</html>
